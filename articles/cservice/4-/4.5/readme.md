### 服务限流降级
Potus为微服务应用提供基于QPS和线程并发的限流方式，通过时间片切分的控制算法，能够对应用的访问流量进行削峰，保障应用服务能够快速拒绝自身容量之外的请求，防止系统雪崩。
限流服务与RPC框架IRIS进行了深度的整合，依赖于中间件SDK后，能够自动识别RPC调用信息，并能够自动跟踪和统计RPC调用，进行限流拦截和控制，无需用户进行额外配置和编码。

#### 限流类型
Potus限流服务对外提供两种类型的限流：QPS和线程并发数限流。

##### QPS限流
QPS限流是对按照一定时间单位内的并发速率来对系统进行限制。QPS与线程数限流相比，最大的好处除了能够按照压测模型的测算进行设置外，另一个最大的好处就是可以对流量进行削峰，防止流量突刺对系统资源进行穿透影响。
QPS虽然度量单位上是秒，但是一般的实现不会基于秒级进行计数统计来进行限流保护，基于秒级的计数时间窗口过大，不能够消除流量突刺。试想一下在一秒的时间窗口内，流量突发集中在后面10ms，那么在最后的时刻，系统流量会变成我们期望值的100倍,可想而知这个时候对于系统来说是多么可怕的灾难。
![](image/qps.png)

QPS限流实现上基于时间窗口的分片来进行计数，将整个QPS的计数周期划分为多个时间窗口，将计数值分散在各个时间窗口进行控制和计算，这样能够避免上面提到的流量突刺的出现，能够有效的将流量进行削峰，将流量洪峰削平，放着洪峰对于系统资源的破坏，例如缓存的热点穿透。

##### 线程并发限流
线程数的限流，通过令牌许可的方式实现，通过预置令牌的数目来控制系统的活跃线程数量，没有获取令牌的线程，快速的失败返回

在线程的入口处获取许可令牌，在执行业务逻辑完毕的出口处归还令牌。在实现上一般使用try{...}finally{...}结构实现，在finally中进行令牌的释放。
线程数的限流多数用于简单系统的负载保护，及自我的熔断保护优雅降级，防止依赖的下游服务RT变长的情况下，造成自身系统性能下降。在例如天猫交易系统这种，依赖下游服务(库存、物流、商品、营销等)较多的系统中，一个服务的变慢可能会对处于核心的交易系统造成不良的影响，所以对于在交易系统中，对于依赖的核心服务都是设置一个自我保护的线程数限流值，在下游服务出问题的情况下进行优雅降级
![](image/bingfa.png)

一般来说，对于服务API，我们设置基于QPS的限流来达到对于系统的保护，对于核心的服务，设置线程并发数限流，来达到系统自我保护之上，提供最大程度服务QPS。

#### 限流设置
##### 微服务API限流
接入了用友云中间件SDK之后，在应用的微服务页面，点击相应的API，就能够对限流进行相应的QPS和线程限流配置。
如下界面
![](image/xianliupeizhi.png)

设置完成之后，限流配置会同步到配置中心配置文件，之后会下发到中间件SDK，限流客户端根据下发的限流值进行限流配置。

##### 自定义限流
potus限流服务除了提供微服务的RPC API的限流之外，还提供用户自定义埋点的限流，用户只需要在代码中调用限流客户端提供的API，就能够进行自定义的限流埋点。
代码示例：

![](image/zidingyixianliu.png)

在代码植入自定义的埋点之后，可以通过配置中心，对strategy.json进行修改，就可以对自定义埋点限流进行配置：
```
{"appName":"test-yjm-provider",
"strategy":[
{"qps":"0","threadCount":"10","desc":"com.yonyou.cloud.service.ISimpleService#testService"},
{"qps":"10","threadCount":"9","desc":"com.yonyou.cloud.service.ISimpleService#testSentinel"},
{"qps":"0","threadCount":"10","desc":"flowcontrol"}
]}
```

通过自定义限流，可以对程序的任何代码块进行限流埋点，可以提供最大程度的自由度。
#### 熔断
potus自带对于服务API的熔断功能，在API累计发生调用错误，和API调用延时达到某一阈值时，触发熔断，自动关闭对于服务API的调用。并且通过请求探测，探测服务是否恢复，如果请求恢复之后，就会触发关闭熔断，恢复正常访问。

默认的熔断设置是1分钟内累计发生的错误达到50%时触发熔断，5秒后启动探测工作，如果这时候请求通过之后，则自动关闭熔断。默认的阈值可以通过配置文件和环境变量进行配置修改。
